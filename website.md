

[Cloudflare](https://dash.cloudflare.com/09b88f62dac8643a6138bdc44d09186c/timmons.family)

Went to google domains.  Change the DNS.

Changed Google name servers to Custom name servers

becky.ns.cloudflare.com
ian.ns.cloudflare.com

Mostly because the documentation is better.

Switched to this new domain settings.


Other cloudflare DNS?
1.1.1.2
1.0.0.2
2606:4700:4700::1112
2606:4700:4700::1002



## setting up Dynamic DNS


[source](https://community.ui.com/questions/Who-wants-Cloudflare-DDNS-support/200b6e0b-ba23-4595-859b-93822b2127e9)
```json

{
  "service": {
    "dns": {
  "dynamic": {
    "interface": {
  "eth0": {
    "service": {
      "custom-cloudflare": {
    "host-name": [
      "hostname.domain.tld"
    ],
    "login": "cloudflare@myemail.com",
    "options": [
      "zone=domain.tld"
    ],
    "password": "cloudflare-api-key",
    "protocol": "cloudflare",
    "server": "api.cloudflare.com/client/v4"
      }
    }
  }
    }
  }
    }
  }
}

```
This seems to go  here:  **/usr/lib/unifi/data/site/[site name directory]/.**


[Unraid Setup Sources](https://forums.unraid.net/topic/78779-update-dns-cloudflare-ddclient/)

```sh
##
## CloudFlare (www.cloudflare.com)
##
use=web
protocol=cloudflare, \
zone=mydomain.com, \
ttl=10, \
login=myemail@myemail.com, \
password=CLOUDFLARE-GLOBAL-API-KEY \
sub1.mydomain.com,sub2.mydomain.com

```


Generate SSL Key

[Source](https://docs.docker.com/engine/security/protect-access/)


```sh
# src: https://docs.docker.com/engine/security/protect-access/

#make ca-key.pem
openssl genrsa -aes256 -out ca-key.pem 4096

#make ca.pem
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem

#server-key.pem
 openssl genrsa -out server-key.pem 4096
# server.csr
 openssl req -subj "/CN=$HOST" -sha256 -new -key server-key.pem -out server.csr
 
 echo subjectAltName = DNS:$HOST,IP:127.0.0.1 >> extfile.cnf
 ```


## DDClient on XEN Server

```bash

#!/bin/bash

##ddclient updater
ddclient
if [ $? -eq 0 ]
then
    echo "SUCCESS $(date)" >> /var/log/ddclient-log
    echo "DDClient Updated" >&1
else
    echo "FAILURE $(date)" >> /var/log/ddclient-log
    echo DDClient Failure >&2
    exit 1
fi
exit 0

```

```conf
#Configuration file for ddclient generated by debconf

#/etc/ddclient.conf

syslog=yes
protocol=cloudflare \
use=web, web=https://api.ipify.org/ \
zone=timmons.family, \
ttl=1, \
cache=/tmp/ddclient.cache, \
login=a.l.timmons@gmail.com, \
password='7069e339178de7c4fa1622d6da7c2ef42fd57' \
timmons.family
```


## Listening on Ports Commands

`ss -tulw`

(truncated)

      Usage: ss [ OPTIONS ]
            ss [ OPTIONS ] [ FILTER ]
        -n, --numeric       don't resolve service names
        -r, --resolve       resolve host names
        -a, --all           display all sockets
        -l, --listening     display listening sockets
        -o, --options       show timer information
        -e, --extended      show detailed socket information
        -m, --memory        show socket memory usage
        -p, --processes     show process using socket
        -i, --info          show internal TCP information
        -s, --summary       show socket usage summary
        -E, --events        continually display sockets as they are destroyed
        -Z, --context       display process SELinux security contexts
        -z, --contexts      display process and socket SELinux security contexts
        -N, --net           switch to the specified network namespace name

        -4, --ipv4          display only IP version 4 sockets
        -6, --ipv6          display only IP version 6 sockets
        -0, --packet        display PACKET sockets
        -t, --tcp           display only TCP sockets
        -M, --mptcp         display only MPTCP sockets
        -S, --sctp          display only SCTP sockets
        -u, --udp           display only UDP sockets
        -d, --dccp          display only DCCP sockets
        -w, --raw           display only RAW sockets
        -x, --unix          display only Unix domain sockets
            --tipc          display only TIPC sockets
            --vsock         display only vsock sockets
        -f, --family=FAMILY display sockets of type FAMILY
            FAMILY := {inet|inet6|link|unix|netlink|vsock|tipc|xdp|help}

        -K, --kill          forcibly close sockets, display what was closed
        -H, --no-header     Suppress header line
        -O, --oneline       socket's data printed on a single line

        -A, --query=QUERY, --socket=QUERY
            QUERY := {all|inet|tcp|mptcp|udp|raw|unix|unix_dgram|unix_stream|unix_seqpacket|packet|netlink|vsock_stream|vsock_dgram|tipc}[,QUERY]

        -D, --diag=FILE     Dump raw information about TCP sockets to FILE
        -F, --filter=FILE   read filter information from FILE
            FILTER := [ state STATE-FILTER ] [ EXPRESSION ]
  
```
Netid  State          Recv-Q   Send-Q   Local Address:Port     Peer Address:Port  Process  
udp    UNCONN   0            0             127.0.0.1:57490             0.0.0.0:*      
udp    UNCONN   0            0             192.168.1.240:57529     0.0.0.0:*      
udp    UNCONN   0            0             192.168.1.241:58825     0.0.0.0:*      
udp    UNCONN   0            0              0.0.0.0:59714               0.0.0.0:*         
```

`sudo lsof -i -P -n | grep LISTEN`

(lsof info)[https://en.wikipedia.org/wiki/Lsof]

lsof 4.93.2
 latest revision: https://github.com/lsof-org/lsof
 latest FAQ: https://github.com/lsof-org/lsof/blob/master/00FAQ
 latest (non-formatted) man page: https://github.com/lsof-org/lsof/blob/master/Lsof.8

```
rpcbind    3068   rpc    8u  IPv4   20213      0t0  TCP *:111 (LISTEN)
rpcbind    3068   rpc   11u  IPv6   20216      0t0  TCP *:111 (LISTEN)
rpc.statd  3073   rpc    8u  IPv4   20233      0t0  TCP *:39315 (LISTEN)
rpc.statd  3073   rpc   11u  IPv6   20237      0t0  TCP *:49555 (LISTEN)
node       6225  root   18u  IPv4 5285877      0t0  TCP 127.0.0.1:33643 (LISTEN)
```

`sudo netstat -tulpn | grep LISTEN`
tcp        0      0 0.0.0.0:55593           0.0.0.0:*               LISTEN      24852/rpc.mountd    
tcp        0      0 127.0.0.1:33643         0.0.0.0:*               LISTEN      6225/node           
tcp        0      0 0.0.0.0:139             0.0.0.0:*               LISTEN      27493/smbd          
tcp        0      0 0.0.0.0:37453           0.0.0.0:*               LISTEN      24852/rpc.mountd    
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      3068/rpcbind        
tcp        0      0 192.168.1.240:80        0.0.0.0:*               LISTEN      24950/nginx: master 



## Setup SSL in unifi

SSH into cloud key

`service unifi stop &`

The **`<unifi_base>`** location will vary depending on your operating system. Find  **`<unifi_base>`**   in the following directories:

UniFi Cloud Key: `/usr/lib/unifi`
Debian/Ubuntu Linux: /usr/lib/unifi
Windows: %userprofile%/Ubiquiti UniFi
https://www.ssls.com/knowledgebase/generating-csr-using-ubiquiti-unifi/
https://medium.com/@munteanu210/how-to-install-an-ssl-certificate-on-unifi-cloud-key-579dac4adb69

Step 2: Generate the CSR code, using the following command:

java -jar *UniFi root*/lib/ace.jar new_cert example.com “Company” “Location (city)” “State or province” “Country code”
(for Linux/Mac OS)

or

java -jar “*UniFi root*\lib\ace.jar” new_cert example.com “Company” “Location (city)” “State or province” “Country code”
(for Windows)

Back up your existing certificate configuration. Create a copy of /etc/ssl/private directory on your local desktop
Once you’ve backed up the Cloud Key directory, remove its content: rm -f /etc/ssl/private/*
Use the OpenSSL toolkit to create a new private key for your certificate. Run the command below:

!!! warning I think this is actually doing not what I think it should

`openssl genrsa -out /etc/ssl/private/cloudkey.key 2048`

Next, generate your CSR file:
```
openssl req -new -batch -subj "/C=US /ST=North_Carolina /L=Charlotte /O=Home /OU=me /CN=unifi.timmons.family /emailAddress=altstockalerts@gmail.com"  -key /etc/ssl/private/cloudkey.key -out /etc/ssl/private/cloudkey.csr

```

java -jar /usr/lib/unifi/lib/ace.jar new_cert timmons.family "Home" "Charlotte" "NC" "USA"
java -jar lib/ace.jar import_cert <signed_cert> [<other_intermediate_root_certs>...]  
[Source](https://michaelrigart.be/ssl-certificate-unifi-controller/)




A better site


openssl pkcs12 -export -in  ./pem.crt  -inkey ./cert.key  -out  ./tempout -passout pass:aircontrolenterprise -name unifi

keytool -importkeystore -srckeystore ./tempout -srcstoretype pkcs12 -srcstorepass aircontrolenterprise -destkeystore /var/lib/unifi/keystore -deststorepass aircontrolenterprise -deststoretype pkcs12 -alias unifi -trustcacerts


short note:

Copy private key from CloudFlare (required?)

or generate a new key
`openssl genrsa -out /etc/ssl/private/cloudkey.key 2048`

Then run:

```
openssl req -new -batch -subj "/C=US/ST=North_Carolina /L=Charlotte /O=Home /OU=me /CN=unifi.timmons.family /emailAddress=altstockalerts@gmail.com"  -key ~/timmons.family.key -out /etc/ssl/private/cloudkey.csr
```
the strings include the spaces and etc until the next slash, so /C=US /ST  throws an error.  Also the `=` is required.

 docker network create --driver macvlan --ip-range 192.168.1.144/28 --subnet 192.168.1.0/24 --gateway 192.168.1.242 --attachable --opt parent=eth2 --aux-address "Home-Assistant-Core=192.168.1.100" dockerlan
398d230769e551deb91b6009f6275fc03f690eba3a2f6d0c7eb713bb281aea26




ROUTE_INFO=$(ip route | grep default )
IPGW=$(echo $ROUTE_INFO | awk '{ print $3}')
IP_INTERFACE=$(echo $ROUTE_INFO | awk '{ print $5}')
OUR_ADDRESS=$(ip addr | grep -A1 $IP_INTERFACE | grep inet | awk '{print $2}' | awk -F "/" '{print $1}')
NETINFO=$(ip route | grep $OUR_ADDRESS | awk '{print $1}') 
CLEAN_NETINFO=$(echo $NETINFO | cut -c1-13)   #added this var to clean NETINFO as I was getting 2 lines 
echo --gateway=$IPGW --subnet=$CLEAN_NETINFO



ROUTE_INFO=$(ip route | grep default |  sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g" )
IPGW=$(echo $ROUTE_INFO | awk '{ print $3}')
IP_INTERFACE=$(echo $ROUTE_INFO | awk '{ print $5}')
OUR_ADDR=$(ip addr |  sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"  | grep -A1 $IP_INTERFACE | grep inet | awk '{print $2}' | awk -F "/" '{print $1}')
NETINFO=$(ip route | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g" | grep $OUR_ADDR | awk '{print $1}')